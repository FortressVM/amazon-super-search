<script>
  const categories = [
    { name: 'All Categories', value: '' },
    { name: 'Books', value: 'stripbooks' },
    { name: 'Electronics', value: 'electronics' },
    { name: 'Clothing & Accessories', value: 'fashion' },
    { name: 'Home & Kitchen', value: 'garden' },
    { name: 'Beauty & Personal Care', value: 'beauty' },
    { name: 'Toys & Games', value: 'toys-and-games' },
    { name: 'Health & Personal Care', value: 'hpc' }
  ];

  const ratings = [
    { name: 'Any Rating', value: '' },
    { name: '4 stars & up', value: '4' },
    { name: '3 stars & up', value: '3' }
  ];

  const toggles = [
    'prime', 'freeShipping', 'subscribeSave', 'pantry', 'videoReview', 'coupons', 'giftWrap',
    'conditionNew', 'conditionUsed', 'organic', 'crueltyFree', 'glutenFree'
  ];

  const toggleMap = {
    prime: 'p_85%3A2470955011',
    freeShipping: 'p_76%3A2661625011',
    videoReview: 'p_n_availability%3A1248812011',
    coupons: 'p_n_feature_thirteen_browse-bin%3A618073011',
    conditionNew: 'p_n_condition-type%3A6461716011',
    conditionUsed: 'p_n_condition-type%3A6461718011',
    // The following are placeholders for features not supported directly by Amazon URL
    subscribeSave: '',
    pantry: '',
    giftWrap: '',
    organic: '',
    crueltyFree: '',
    glutenFree: ''
  };

  window.onload = () => {
    populateDropdown('category', categories);
    populateDropdown('minRating', ratings);
    restoreLastSearch();
    attachClickTracking();
  };

  function populateDropdown(id, list) {
    const select = document.getElementById(id);
    if (!select) return;
    list.forEach(opt => {
      const option = document.createElement('option');
      option.textContent = opt.name;
      option.value = opt.value;
      select.appendChild(option);
    });
  }

  function restoreLastSearch() {
    const saved = localStorage.getItem('last-search');
    if (saved) {
      const data = JSON.parse(saved);
      for (const [id, val] of Object.entries(data)) {
        const el = document.getElementById(id);
        if (el) {
          if (el.type === 'checkbox') el.checked = val === true;
          else el.value = val;
        }
      }
    }
  }

  function attachClickTracking() {
    document.querySelectorAll('button, select, input').forEach(el => {
      el.addEventListener('click', () => {
        console.log(`Clicked: ${el.id || el.name || el.tagName}`);
      });
    });
  }

  function savePreset() {
    const query = document.getElementById('search').value;
    if (!query) return alert('Enter a search query first.');
    const key = prompt('Name this preset:');
    if (key) {
      const data = getCurrentSearch();
      localStorage.setItem(`preset-${key}`, JSON.stringify(data));
      localStorage.setItem('last-search', JSON.stringify(data));
    }
  }

  function getCurrentSearch() {
    const obj = {
      search: document.getElementById('search')?.value || '',
      category: document.getElementById('category')?.value || '',
      minRating: document.getElementById('minRating')?.value || ''
    };
    toggles.forEach(id => {
      const el = document.getElementById(id);
      if (el) obj[id] = el.checked;
    });
    return obj;
  }

  function startSearch() {
    const TAG = 'echolover25-20';
    const query = document.getElementById('search')?.value.trim();
    if (!query) return alert('Search keywords are required.');

    const category = document.getElementById('category')?.value;
    const rating = document.getElementById('minRating')?.value;
    const filters = getCurrentSearch();

    localStorage.setItem('last-search', JSON.stringify(filters));

    let q = encodeURIComponent(query);
    let url = `https://www.amazon.com/s?k=${q}&tag=${TAG}`;

    if (category) url += `&i=${category}`;
    if (rating === '4') url += `&rh=p_72%3A2661618011`;
    else if (rating === '3') url += `&rh=p_72%3A2661619011`;

    for (const [key, param] of Object.entries(toggleMap)) {
      if (filters[key] && param) {
        url += `&rh=${param}`;
      }
    }

    logDebug(`üåê Opening URL: ${url}`);
    window.open(url, '_blank');
  }

  function logDebug(msg) {
    console.log(msg);
  }
</script>
