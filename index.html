<script>
  function toggleTheme() {
    document.body.classList.toggle('dark');
  }

  function toggleAdvanced() {
    const adv = document.getElementById('advancedSection'),
          txt = document.getElementById('toggleText'),
          arr = document.getElementById('toggleArrow'),
          hidden = adv.classList.toggle('hidden');
    txt.textContent = hidden ? 'Show Advanced Filters' : 'Hide Advanced Filters';
    arr.textContent = hidden ? '‚Øà' : '‚ØÜ';
  }

  function savePreset() {
    const query = document.getElementById('search').value;
    if (!query) return alert('Enter a search query first.');
    const key = prompt('Name this preset:');
    if (key) localStorage.setItem(`preset-${key}`, JSON.stringify(getCurrentSearch()));
  }

  function loadPreset(presetId) {
    if (!presetId) return;
    const data = localStorage.getItem(`preset-${presetId}`);
    if (!data) return alert('Preset not found.');
    const values = JSON.parse(data);
    for (const [id, val] of Object.entries(values)) {
      const el = document.getElementById(id);
      if (el) el.value = val;
    }
  }

  function getCurrentSearch() {
    return {
      search: document.getElementById('search')?.value || '',
      category: document.getElementById('category')?.value || '',
      minPrice: document.getElementById('minPrice')?.value || '',
      maxPrice: document.getElementById('maxPrice')?.value || '',
      minRating: document.getElementById('minRating')?.value || '',
      minReviews: document.getElementById('minReviews')?.value || '',
      includeKeywords: document.getElementById('includeKeywords')?.value || '',
      excludeKeywords: document.getElementById('excludeKeywords')?.value || '',
      exactPhrase: document.getElementById('exactPhrase')?.value || '',
      language: document.getElementById('language')?.value || '',
      currency: document.getElementById('currency')?.value || '',
      preset: document.getElementById('preset')?.value || '',
      export: document.getElementById('export')?.value || ''
    };
  }

  function startSearch() {
    logDebug('üîç Search triggered');
    // Element checks to prevent blank screen
    const requiredIds = ['search', 'category', 'minPrice', 'maxPrice', 'minRating', 'minReviews', 'includeKeywords', 'excludeKeywords', 'exactPhrase', 'language', 'currency', 'preset', 'export'];
    for (const id of requiredIds) {
      if (!document.getElementById(id)) {
        alert(`Missing input element with ID: ${id}`);
        return;
      }
    }
    const TAG = 'echolover25-20';
    let query = document.getElementById('search')?.value.trim() || '';
    const include = document.getElementById('includeKeywords')?.value.trim() || '';
    const exclude = document.getElementById('excludeKeywords')?.value.trim() || '';
    const phrase = document.getElementById('exactPhrase')?.value.trim() || '';

    if (phrase) query += ` "${phrase}"`;
    if (include) query += ` ${include}`;
    if (exclude) query += ` -${exclude.split(',').join(' -')}`;

    const q = encodeURIComponent(query);
    let url = `https://www.amazon.com/s?k=${q}&tag=${TAG}`;
    logDebug(`üîó Base URL: ${url}`);

    const category = document.getElementById('category')?.value;
    if (category) url += `&i=${category}`;

    const minPrice = document.getElementById('minPrice')?.value;
    const maxPrice = document.getElementById('maxPrice')?.value;
    if (minPrice || maxPrice) {
      logDebug(`üí≤ Price range: ${minPrice} - ${maxPrice}`);
      const minCents = Math.floor((+minPrice || 0) * 100);
      const maxCents = Math.floor((+maxPrice || 99999) * 100);
      url += `&rh=p_36%3A${minCents}-${maxCents}`;
    }

    const minRating = document.getElementById('minRating')?.value;
    if (minRating === '4') url += `&rh=p_72%3A2661618011`;
    if (minRating === '3') url += `&rh=p_72%3A2661619011`;

    const minReviews = document.getElementById('minReviews')?.value;
    if (minReviews) url += `&rh=p_n_feature_four_browse-bin%3A${minReviews}`;

    const sort = document.getElementById('sort');
    if (sort && sort.value && sort.value !== 'relevance') {
      url += `&s=${sort.value}`;
    }

    const exportType = document.getElementById('export')?.value;
    if (exportType) {
      logDebug(`üì§ Exporting as: ${exportType}`);
      const output = `Search Query: ${query}\nURL: ${url}`;
      const blob = new Blob([output], { type: exportType === 'csv' ? 'text/csv' : 'application/octet-stream' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `amazon_search.${exportType}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } else {
      logDebug('üåê Opening Amazon URL in new tab');
      window.open(url, '_blank');
    }
  }


  // Debug panel setup
  function logDebug(message) {
    let panel = document.getElementById('debugPanel');
    if (!panel) {
      panel = document.createElement('div');
      panel.id = 'debugPanel';
      panel.style.position = 'fixed';
      panel.style.bottom = '0';
      panel.style.left = '0';
      panel.style.right = '0';
      panel.style.background = 'rgba(0,0,0,0.8)';
      panel.style.color = '#0f0';
      panel.style.padding = '10px';
      panel.style.fontSize = '12px';
      panel.style.fontFamily = 'monospace';
      panel.style.maxHeight = '150px';
      panel.style.overflowY = 'auto';
      document.body.appendChild(panel);
    }
    const timestamp = new Date().toLocaleTimeString();
    panel.innerHTML += `<div>[${timestamp}] ${message}</div>`;
  }
</script>
